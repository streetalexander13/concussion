<section class="measurement">
  <div class="progress-bar">
    <div class="progress" [style.width.%]="(currentExerciseIndex() / 5) * 100"></div>
    <div class="progress-text">{{ currentExerciseIndex() }} / 5 exercises</div>
  </div>

  <ng-container [ngSwitch]="step()">
    <div *ngSwitchCase="'baseline'" class="card fade-in">
      <div class="emoji-icon">🧠</div>
      <h2>Try Our Recovery Exercises</h2>
      <p class="subtitle">Start by rating your current symptoms</p>
      
      <div class="demo-badge">
        <span class="emoji">🎯</span>
        <span>Demo Mode - Sign up to save your progress!</span>
      </div>
      
      <div class="slider-container">
        <div class="slider-row">
          <input type="range" min="0" max="10" [value]="baseline()" (input)="baseline.set(+$any($event.target).value)" />
        </div>
        <div class="value-display">
          <span class="value-number pulse">{{ baseline() }}</span>
          <span class="value-label">/10</span>
        </div>
        <div class="severity-labels">
          <span>😊 None</span>
          <span>😐 Mild</span>
          <span>😰 Severe</span>
        </div>
      </div>
      <button type="button" class="primary btn-large" (click)="confirmBaseline()">
        <span>Continue</span>
        <span class="arrow">→</span>
      </button>
    </div>

    <div *ngSwitchCase="'interstitial'" class="card fade-in">
      <div class="emoji-icon bounce">💪</div>
      <h2>Ready for {{ currentExercise()?.title }}?</h2>
      <p class="subtitle">{{ currentExercise()?.description }}</p>
      
      <app-exercise-animation [exerciseId]="currentExercise()?.id || ''"></app-exercise-animation>
      
      <div class="prep-note">Please take a comfortable seated position</div>
      <div class="action-buttons">
        <button type="button" class="primary btn-large" (click)="beginExercise()">
          <span>Start Exercise</span>
          <span class="play-icon">▶</span>
        </button>
        <button type="button" class="secondary btn-medium skip-btn" (click)="skipExercise()">
          <span>⏭</span>
          <span>Skip</span>
        </button>
      </div>
    </div>

    <div *ngSwitchCase="'exercise'" class="card fade-in exercise-card">
      <h2>{{ currentExercise()?.title }}</h2>
      <p class="desc">{{ currentExercise()?.description }}</p>

      <div class="countdown-wrapper" *ngIf="countdown() > 0">
        <div class="countdown pulse">{{ countdown() }}</div>
        <p class="countdown-label">Get ready...</p>
      </div>

      <div class="timer-wrapper" *ngIf="countdown() <= 0 && timer() > 0">
        <div class="timer-circle">
          <svg class="timer-svg" viewBox="0 0 100 100">
            <defs>
              <linearGradient id="timer-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
              </linearGradient>
            </defs>
            <circle cx="50" cy="50" r="45" class="timer-bg" />
            <circle cx="50" cy="50" r="45" class="timer-progress"
              [style.stroke-dashoffset]="282 * (1 - timer() / 30)" />
          </svg>
          <div class="timer-text">{{ timer() }}<span>s</span></div>
        </div>
        
        <app-metronome 
          *ngIf="currentExercise()?.hasMetronome"
          [initialBpm]="currentBpm()"
          [isPlaying]="metronomeOn()">
        </app-metronome>
        
        <div class="timer-controls">
          <button type="button" class="control-btn time-adjust" (click)="subtractTime()">
            <span>−10s</span>
          </button>
          <button type="button" *ngIf="!isPaused()" class="control-btn pause" (click)="pauseTimer()">
            <span>⏸</span>
            <span>Pause</span>
          </button>
          <button type="button" *ngIf="isPaused()" class="control-btn resume" (click)="resumeTimer()">
            <span>▶</span>
            <span>Resume</span>
          </button>
          <button type="button" class="control-btn restart" (click)="restartTimer()">
            <span>↻</span>
            <span>Restart</span>
          </button>
          <button type="button" class="control-btn time-adjust" (click)="addTime()">
            <span>+10s</span>
          </button>
          <button type="button" class="control-btn skip" (click)="skipExercise()">
            <span>⏭</span>
            <span>Skip</span>
          </button>
        </div>
      </div>

      <div class="symptom-check" *ngIf="countdown() <= 0 && timer() <= 0">
        <p class="check-title">Did your symptoms worsen?</p>
        <div class="check-buttons">
          <button type="button" class="check-btn no-btn" (click)="recordSymptom(false)">
            <span class="emoji">😊</span>
            <span>No change</span>
          </button>
          <div class="yes-section">
            <div class="severity-input">
              <label>Severity (1-9)</label>
              <input type="number" min="1" max="9" value="3" #sev class="severity-number" />
            </div>
            <button type="button" class="check-btn yes-btn primary" (click)="recordSymptom(true, +sev.value)">
              <span class="emoji">😰</span>
              <span>Yes, worsened</span>
            </button>
          </div>
        </div>
        <div class="bottom-actions">
          <button type="button" class="secondary btn-medium repeat-btn" (click)="repeatExercise()">
            <span>🔁</span>
            <span>Repeat Exercise</span>
          </button>
        </div>
      </div>
    </div>

    <div *ngSwitchCase="'done'" class="card fade-in completion-card">
      <div class="emoji-icon bounce">🎉</div>
      <h2>Great job!</h2>
      <p class="subtitle">You've tried all the exercises</p>
      
      <div class="completion-stats">
        <div class="stat">
          <span class="stat-number">5</span>
          <span class="stat-label">Exercises</span>
        </div>
        <div class="stat">
          <span class="stat-number">~3</span>
          <span class="stat-label">Minutes</span>
        </div>
      </div>
      
      <div class="signup-cta">
        <div class="cta-icon">💾</div>
        <h3>Want to track your progress?</h3>
        <p>Sign up to save your results, track improvements over time, and get personalized recommendations!</p>
        
        <div class="cta-features">
          <div class="feature">
            <span class="feature-icon">📊</span>
            <span>Track daily progress</span>
          </div>
          <div class="feature">
            <span class="feature-icon">📈</span>
            <span>View trends over time</span>
          </div>
          <div class="feature">
            <span class="feature-icon">🎯</span>
            <span>Personalized exercises</span>
          </div>
          <div class="feature">
            <span class="feature-icon">🔔</span>
            <span>Daily reminders</span>
          </div>
        </div>
        
        <button type="button" class="primary btn-large cta-btn" (click)="goToSignup()">
          <span>Sign Up to Save Progress</span>
          <span class="arrow">→</span>
        </button>
        
        <p class="cta-note">It's free and takes less than 30 seconds!</p>
      </div>
    </div>
  </ng-container>
</section>
