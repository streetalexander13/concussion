  <section class="start">
    <!-- Metronome component - always rendered for sound effects, positioned absolutely and hidden -->
    <app-metronome 
      [initialBpm]="currentBpm()"
      [isPlaying]="metronomeOn()"
      [style.position]="'absolute'"
      [style.top]="'-9999px'">
    </app-metronome>

    <div class="progress-bar">
      <div class="progress" [style.width.%]="(currentExerciseIndex() / 5) * 100"></div>
      <div class="progress-text">{{ currentExerciseIndex() }} / 5 exercises</div>
    </div>

    <!-- Dosage Guidelines Section -->
    <div class="dosage-section" *ngIf="step() !== 'done'">
      <button type="button" class="dosage-toggle" (click)="toggleDosage()">
        <span class="dosage-icon">â„¹ï¸</span>
        <span>Exercise Guidelines</span>
        <span class="toggle-arrow" [class.open]="showDosage()">â–¼</span>
      </button>
      <div class="dosage-content" *ngIf="showDosage()">
        <h3>Dosage</h3>
        <ul>
          <li>Do each set for a <strong>maximum of 30 seconds</strong> and do a cumulative time of <strong>5-10 minutes</strong>.</li>
          <li>Start in <strong>sitting</strong> then <strong>stand</strong> when easy, progress by putting <strong>feet together</strong> and then <strong>stand on one leg</strong> when easy</li>
          <li>Increase speed of movement in <strong>5bpm increments</strong></li>
        </ul>
        <h4>Conditions for progression:</h4>
        <ul class="progression-rules">
          <li><span class="severity-badge green">0/10</span> for 2 days â†’ go up by 5bpm</li>
          <li><span class="severity-badge yellow">1/10 or 2/10</span> â†’ stay at the same speed</li>
          <li><span class="severity-badge red">More than 2/10</span> â†’ go back to previous speed</li>
        </ul>
      </div>
    </div>

  <ng-container [ngSwitch]="step()">
    <div *ngSwitchCase="'baseline'" class="card fade-in">
      <div class="emoji-icon">ğŸ§ </div>
      <h2>What's your baseline today?</h2>
      <p class="subtitle">Rate your current symptoms after resting</p>
      
      <div *ngIf="loading()" class="loading-state">
        <div class="spinner"></div>
        <p>Loading your session...</p>
      </div>
      
      <div *ngIf="!loading()" class="slider-container">
        <div class="slider-row">
          <input type="range" min="0" max="10" [value]="baseline()" (input)="baseline.set(+$any($event.target).value)" />
        </div>
        <div class="value-display">
          <span class="value-number pulse">{{ baseline() }}</span>
          <span class="value-label">/10</span>
        </div>
        <div class="severity-labels">
          <span>ğŸ˜Š None</span>
          <span>ğŸ˜ Mild</span>
          <span>ğŸ˜° Severe</span>
        </div>
      </div>
      <button type="button" class="primary btn-large" (click)="confirmBaseline()" [disabled]="loading()">
        <span *ngIf="!loading()">Continue</span>
        <span *ngIf="loading()">Loading...</span>
        <span class="arrow" *ngIf="!loading()">â†’</span>
      </button>
    </div>

    <div *ngSwitchCase="'interstitial'" class="card fade-in">
      <div class="emoji-icon bounce">ğŸ’ª</div>
      <h2>Ready for {{ currentExercise()?.title }}?</h2>
      <p class="subtitle">{{ currentExercise()?.description }}</p>
      
      <app-exercise-animation [exerciseId]="currentExercise()?.id || ''"></app-exercise-animation>
      
      <!-- Show BPM recommendation if available -->
      <div *ngIf="bpmRecommendation()" class="bpm-recommendation">
        <p>{{ bpmRecommendation() }}</p>
      </div>
      
      <!-- Show BPM controls if exercise has metronome -->
      <div *ngIf="currentExercise()?.hasMetronome" class="bpm-preview">
        <div class="bpm-preview-label">
          <span>ğŸµ</span>
          <span>Metronome Speed</span>
        </div>
        <div class="bpm-controls-preview">
          <button type="button" class="bpm-adjust-btn" (click)="adjustBpm(-5)">âˆ’</button>
          <div class="bpm-info-preview">
            <div class="bpm-value">{{ currentBpm() }}</div>
            <div class="bpm-label">BPM</div>
          </div>
          <button type="button" class="bpm-adjust-btn" (click)="adjustBpm(5)">+</button>
        </div>
        <p class="bpm-hint">Adjust the speed to match your comfort level</p>
      </div>
      
      w<div class="prep-note">Please take a comfortable seated position</div>
      <div class="audio-note">
        <small>ğŸ“¢ You'll hear countdown beeps when you start</small>
        <button type="button" class="test-audio-btn" (click)="testAudio()">
          ğŸ”Š Test Sound
        </button>
      </div>
      <div class="action-buttons">
        <button type="button" class="primary btn-large" (click)="beginExercise()">
          <span>Start Exercise</span>
          <span class="play-icon">â–¶</span>
        </button>
        <button type="button" class="secondary btn-medium skip-btn" (click)="skipExercise()">
          <span>â­</span>
          <span>Skip</span>
        </button>
      </div>
    </div>

    <div *ngSwitchCase="'exercise'" class="card fade-in exercise-card">
      <h2>{{ currentExercise()?.title }}</h2>
      <p class="desc">{{ currentExercise()?.description }}</p>
      
      <div class="countdown-wrapper" *ngIf="countdown() > 0">
        <div class="countdown pulse">{{ countdown() }}</div>
        <p class="countdown-label">Get ready...</p>
      </div>
      
      <div class="timer-wrapper" *ngIf="countdown() <= 0 && timer() > 0">
        <div class="timer-circle">
          <svg class="timer-svg" viewBox="0 0 100 100">
            <defs>
              <linearGradient id="timer-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
              </linearGradient>
            </defs>
            <circle cx="50" cy="50" r="45" class="timer-bg" />
            <circle cx="50" cy="50" r="45" class="timer-progress" 
              [style.stroke-dashoffset]="282 * (1 - timer() / 30)" />
          </svg>
          <div class="timer-text">{{ timer() }}</div>
        </div>
        
        <!-- Show metronome controls if exercise has metronome -->
        <div *ngIf="currentExercise()?.hasMetronome" class="metronome-controls-wrapper">
          <div class="bpm-controls">
            <button type="button" class="bpm-adjust-btn" (click)="adjustBpm(-5)">âˆ’</button>
            <div class="bpm-info">
              <div class="bpm-value">{{ currentBpm() }}</div>
              <div class="bpm-label">BPM</div>
              <div class="beat-indicator" [class.active]="metronomeOn()">â—</div>
            </div>
            <button type="button" class="bpm-adjust-btn" (click)="adjustBpm(5)">+</button>
          </div>
        </div>
        
        <div class="timer-controls">
          <button type="button" class="control-btn time-adjust" (click)="subtractTime()">
            <span>âˆ’10s</span>
          </button>
          <button type="button" *ngIf="!isPaused()" class="control-btn pause" (click)="pauseTimer()">
            <span>â¸</span>
            <span>Pause</span>
          </button>
          <button type="button" *ngIf="isPaused()" class="control-btn resume" (click)="resumeTimer()">
            <span>â–¶</span>
            <span>Resume</span>
          </button>
          <button type="button" class="control-btn restart" (click)="restartTimer()">
            <span>â†»</span>
            <span>Restart</span>
          </button>
          <button type="button" class="control-btn time-adjust" (click)="addTime()">
            <span>+10s</span>
          </button>
          <button type="button" class="control-btn skip" (click)="skipExercise()">
            <span>â­</span>
            <span>Skip</span>
          </button>
        </div>
      </div>

      <div class="symptom-check" *ngIf="countdown() <= 0 && timer() <= 0">
        <p class="check-title">Did your symptoms worsen?</p>
        <div class="check-buttons">
          <button type="button" class="check-btn no-btn" (click)="recordSymptom(false)">
            <span class="emoji">ğŸ˜Š</span>
            <span>No change</span>
          </button>
          <div class="yes-section">
            <div class="severity-input">
              <label>Severity (1-9)</label>
              <input type="number" min="1" max="9" value="3" #sev class="severity-number" />
            </div>
            <button type="button" class="check-btn yes-btn primary" (click)="recordSymptom(true, +sev.value)">
              <span class="emoji">ğŸ˜°</span>
              <span>Yes, worsened</span>
            </button>
          </div>
        </div>
        <div class="bottom-actions">
          <button type="button" class="secondary btn-medium repeat-btn" (click)="repeatExercise()">
            <span>ğŸ”</span>
            <span>Repeat Exercise</span>
          </button>
          <button type="button" class="skip-link" (click)="skipExercise()">
            Skip this exercise â†’
          </button>
        </div>
      </div>
    </div>

    <div *ngSwitchCase="'done'" class="card fade-in completion-card">
      <div class="emoji-icon bounce">ğŸ‰</div>
      <h2>Amazing work!</h2>
      <p class="subtitle">You've completed today's exercises</p>
      <div class="completion-stats">
        <div class="stat">
          <span class="stat-number">5</span>
          <span class="stat-label">Exercises</span>
        </div>
        <div class="stat">
          <span class="stat-number">~3</span>
          <span class="stat-label">Minutes</span>
        </div>
      </div>
      <button type="button" class="primary btn-large" (click)="goToTrack()">
        <span>View Progress</span>
        <span class="arrow">â†’</span>
      </button>
    </div>
  </ng-container>
</section>


